<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a1e">
<title>Focus-5</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='42' fill='%231a1a1e' stroke='%234A8C4A' stroke-width='6'/><path d='M30 50L45 65L72 35' stroke='%234A8C4A' stroke-width='7' stroke-linecap='round' stroke-linejoin='round' fill='none'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getFirestore, doc, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  // ‚îÄ‚îÄ PASTE YOUR FIREBASE CONFIG HERE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyAqT6YM7W0c63d224kdGaR3SIYsnCrZhcw",
  authDomain: "focus-5-44158.firebaseapp.com",
  projectId: "focus-5-44158",
  storageBucket: "focus-5-44158.firebasestorage.app",
  messagingSenderId: "929896339922",
  appId: "1:929896339922:web:1e09d143c0c755fec2100b"
};
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  try {
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const DOC_REF = doc(db, 'focus5', 'tasks');

    window.__f5_saveData = async function(data) {
      try {
        await setDoc(DOC_REF, { payload: JSON.stringify(data) });
      } catch(e) {
        window.__f5_setError('Save failed: ' + e.message);
      }
    };

    window.__f5_onData = function(cb, onErr) {
      return onSnapshot(DOC_REF,
        snap => {
          // Document exists: pass data. Does not exist yet (first ever use): pass empty signal.
          cb(snap.exists() ? snap.data().payload : '__EMPTY__');
        },
        err => {
          if (onErr) onErr(err);
        }
      );
    };

    window.__f5_ready = true;
    document.dispatchEvent(new Event('f5-firebase-ready'));
  } catch(e) {
    window.__f5_initError = e.message;
    document.dispatchEvent(new Event('f5-firebase-ready'));
  }
</script>

<style>
  :root {
    --bg: #1a1a1e;
    --bg-card: #26262b;
    --bg-hover: #2e2e34;
    --bg-input: #222227;
    --border: #3a3a42;
    --border-light: #2e2e34;
    --text: #e4e4e6;
    --text-secondary: #b0b0b6;
    --text-muted: #808088;
    --text-faint: #606068;
    --checkbox-border: #505058;
    --green: #6abf6a;
    --green-bg: #1e3a1e;
    --gold: #F5C542;
    --gold-dark: #7A5F00;
    --comp-title: #808088;
    --danger: #e06a6a;
    --danger-bg: #331c1c;
    --border-focus: #6abf6a;
    --due-normal-bg: #252830; --due-normal-text: #8898b0;
    --due-soon-bg: #332e18; --due-soon-text: #d4b020;
    --due-urgent-bg: #332418; --due-urgent-text: #e08820;
    --due-overdue-bg: #331c1c; --due-overdue-text: #e06a6a;
    --nav-h: 58px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    flex-shrink: 0;
    padding: 16px 20px 12px;
    padding-top: calc(16px + env(safe-area-inset-top, 0px));
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg);
    z-index: 10;
  }
  .header-left { display: flex; flex-direction: column; gap: 1px; }
  .header-logo {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    font-weight: 400;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
  }
  .header-date {
    font-size: 0.8125rem;
    color: var(--text-faint);
  }

  /* Daily tracker in header */
  .header-tracker { display: flex; align-items: center; gap: 5px; }
  .tracker-dot { width: 22px; height: 22px; }
  .tracker-dot svg { display: block; }

  /* ‚îÄ‚îÄ SCROLL BODY ‚îÄ‚îÄ */
  .scroll-body {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: calc(var(--nav-h) + var(--safe-bottom) + 80px);
  }

  /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
  .bottom-nav {
    flex-shrink: 0;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: calc(var(--nav-h) + var(--safe-bottom));
    padding-bottom: var(--safe-bottom);
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    display: flex;
    z-index: 20;
  }
  .nav-tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    border: none;
    background: none;
    color: var(--text-faint);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.6875rem;
    font-weight: 500;
    cursor: pointer;
    padding: 0;
    transition: color 0.15s;
    position: relative;
  }
  .nav-tab.active { color: var(--green); }
  .nav-tab svg { flex-shrink: 0; }
  .nav-badge {
    position: absolute;
    top: 6px; right: calc(50% - 18px);
    background: var(--text);
    color: var(--bg);
    font-family: 'DM Mono', monospace;
    font-size: 0.5625rem;
    font-weight: 600;
    border-radius: 10px;
    padding: 1px 5px;
    min-width: 16px;
    text-align: center;
    line-height: 1.4;
  }

  /* ‚îÄ‚îÄ SECTION PADDING ‚îÄ‚îÄ */
  .section { padding: 16px 20px; }
  .section-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.6875rem;
    font-weight: 400;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-faint);
    margin-bottom: 12px;
  }

  /* ‚îÄ‚îÄ TASK ITEMS ‚îÄ‚îÄ */
  .task-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 13px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 10px;
    margin-bottom: 8px;
    transition: background 0.15s;
  }
  .task-item.hvm {
    background: rgba(245, 197, 66, 0.05);
    border-color: rgba(245, 197, 66, 0.15);
  }
  .task-item:active { background: var(--bg-hover); }

  .checkbox {
    width: 22px; height: 22px;
    border: 1.5px solid var(--checkbox-border);
    border-radius: 50%;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.15s;
  }
  .checkbox:active { transform: scale(0.9); }

  .task-body { flex: 1; min-width: 0; }
  .task-title {
    font-size: 0.9375rem;
    font-weight: 400;
    color: var(--text);
    line-height: 1.35;
    word-break: break-word;
  }
  .task-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 5px;
    flex-wrap: wrap;
  }
  .hvm-star { color: var(--gold); }

  .due-badge, .age-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.625rem;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 4px;
  }
  .due-normal { background: var(--due-normal-bg); color: var(--due-normal-text); }
  .due-soon { background: var(--due-soon-bg); color: var(--due-soon-text); }
  .due-urgent { background: var(--due-urgent-bg); color: var(--due-urgent-text); }
  .due-overdue { background: var(--due-overdue-bg); color: var(--due-overdue-text); }
  .age-badge { background: #252830; color: #8898b0; }

  .notes-icon { color: var(--text-faint); opacity: 0.7; }

  .task-action {
    flex-shrink: 0;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-faint);
    padding: 6px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.15s;
  }
  .task-action:active { color: var(--text-secondary); }

  /* ‚îÄ‚îÄ ADD TASK FAB ‚îÄ‚îÄ */
  .fab {
    position: fixed;
    bottom: calc(var(--nav-h) + var(--safe-bottom) + 16px);
    right: 20px;
    width: 52px; height: 52px;
    border-radius: 50%;
    background: var(--green);
    border: none;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 16px rgba(106,191,106,0.35);
    z-index: 15;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .fab:active { transform: scale(0.93); box-shadow: 0 2px 8px rgba(106,191,106,0.25); }
  .fab svg { color: #1a1a1e; }

  /* ‚îÄ‚îÄ ADD TASK SHEET ‚îÄ‚îÄ */
  .sheet-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 30;
    display: none;
    align-items: flex-end;
  }
  .sheet-overlay.open { display: flex; }
  .sheet {
    width: 100%;
    background: var(--bg-card);
    border-radius: 20px 20px 0 0;
    border-top: 1px solid var(--border);
    padding: 0 20px;
    padding-bottom: calc(20px + var(--safe-bottom));
    animation: slideUp 0.22s ease;
  }
  @keyframes slideUp {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .sheet-handle {
    width: 36px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 12px auto 20px;
  }
  .sheet-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 16px;
  }
  .sheet-input {
    width: 100%;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 13px 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    color: var(--text);
    outline: none;
    transition: border-color 0.15s;
    resize: none;
  }
  .sheet-input:focus { border-color: var(--border-focus); }
  .sheet-input::placeholder { color: var(--text-faint); }
  .sheet-row { display: flex; gap: 10px; margin-top: 10px; align-items: center; }
  .sheet-date {
    flex: 1;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    color: var(--text);
    outline: none;
  }
  .sheet-date:focus { border-color: var(--border-focus); }
  .hvm-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    color: var(--text-muted);
    font-size: 0.8125rem;
    transition: all 0.15s;
  }
  .hvm-toggle.active {
    border-color: rgba(245,197,66,0.4);
    background: rgba(245,197,66,0.07);
    color: var(--gold);
  }
  .sheet-actions { display: flex; gap: 10px; margin-top: 14px; }
  .btn-cancel {
    flex: 1;
    padding: 13px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: none;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
  }
  .btn-add {
    flex: 2;
    padding: 13px;
    border-radius: 10px;
    border: none;
    background: var(--green);
    color: #1a1a1e;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .btn-add:disabled { opacity: 0.4; }

  /* ‚îÄ‚îÄ DESTINATION TOGGLE ‚îÄ‚îÄ */
  .dest-toggle {
    display: flex;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 14px;
  }
  .dest-btn {
    flex: 1;
    padding: 9px;
    border: none;
    background: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
  }
  .dest-btn.active {
    background: var(--bg-card);
    color: var(--text);
  }

  /* ‚îÄ‚îÄ COMPLETED VIEW ‚îÄ‚îÄ */
  .comp-day-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.6875rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-faint);
    padding: 0 4px;
    margin-bottom: 8px;
    margin-top: 16px;
    display: flex;
    justify-content: space-between;
  }
  .comp-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 14px;
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 10px;
    margin-bottom: 6px;
  }
  .comp-check {
    width: 20px; height: 20px;
    border-radius: 5px;
    background: var(--green);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .comp-check.hvm { background: var(--gold); }
  .comp-title {
    font-size: 0.875rem;
    color: var(--comp-title);
    flex: 1;
    word-break: break-word;
  }
  .undo-btn {
    flex-shrink: 0;
    background: none;
    border: none;
    color: var(--text-faint);
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    display: flex;
  }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-faint);
  }
  .empty-icon {
    font-size: 2rem;
    margin-bottom: 12px;
    opacity: 0.4;
  }
  .empty-text { font-size: 0.875rem; }

  /* ‚îÄ‚îÄ SLOT INDICATOR ‚îÄ‚îÄ */
  .slot-info {
    font-family: 'DM Mono', monospace;
    font-size: 0.6875rem;
    color: var(--text-faint);
    margin-bottom: 12px;
    padding: 0 4px;
  }

  /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
  .loading-screen {
    position: fixed; inset: 0;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    z-index: 100;
  }
  .loading-logo {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
  }
  .loading-spinner {
    width: 24px; height: 24px;
    border: 2px solid var(--border);
    border-top-color: var(--green);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ CONFIG ERROR ‚îÄ‚îÄ */
  .config-error {
    position: fixed; inset: 0;
    background: var(--bg);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 32px;
    z-index: 100;
    text-align: center;
  }
  .config-error.show { display: flex; }
  .config-error h2 { color: var(--text); font-size: 1.125rem; }
  .config-error p { color: var(--text-muted); font-size: 0.875rem; line-height: 1.6; }
  .config-error code {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 2px 6px;
    font-family: 'DM Mono', monospace;
    font-size: 0.8125rem;
    color: var(--green);
  }

  /* ‚îÄ‚îÄ COMPLETING ANIMATION ‚îÄ‚îÄ */
  @keyframes completeFlash {
    0% { background: var(--green-bg); }
    100% { background: transparent; }
  }
  .task-item.completing { animation: completeFlash 0.4s ease forwards; }
</style>
</head>
<body>

<!-- Loading screen -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">Focus-5</div>
  <div class="loading-spinner"></div>
  <div id="loadingStatus" style="font-size:0.75rem;color:var(--text-faint);font-family:'DM Mono',monospace;margin-top:8px;">Connecting to Firebase‚Ä¶</div>
</div>

<!-- Config/connection error -->
<div class="config-error" id="configError">
  <div style="font-size:2rem" id="errorEmoji">‚öôÔ∏è</div>
  <h2 id="errorTitle">Firebase not configured</h2>
  <p id="errorBody">Open <code>focus5-mobile.html</code> in a text editor and paste your Firebase config where it says <code>YOUR_API_KEY</code>. See <strong>SETUP-GUIDE.md</strong> for step-by-step instructions.</p>
  <p id="errorDetail" style="font-family:monospace;font-size:0.75rem;color:#e06a6a;margin-top:8px;word-break:break-all;"></p>
</div>

<!-- Header -->
<div class="header" id="appHeader" style="display:none">
  <div class="header-left">
    <div class="header-logo">Focus-5</div>
    <div class="header-date" id="headerDate"></div>
  </div>
  <div class="header-tracker" id="headerTracker"></div>
</div>

<!-- Scroll body -->
<div class="scroll-body" id="scrollBody" style="display:none">
  <div id="viewToday" class="section"></div>
  <div id="viewBacklog" class="section" style="display:none"></div>
  <div id="viewCompleted" class="section" style="display:none"></div>
</div>

<!-- Bottom nav -->
<nav class="bottom-nav" id="bottomNav" style="display:none">
  <button class="nav-tab active" id="navToday" onclick="switchView('today')">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.75"/><path d="M12 7v5l3 3" stroke="currentColor" stroke-width="1.75" stroke-linecap="round"/></svg>
    Today
  </button>
  <button class="nav-tab" id="navBacklog" onclick="switchView('backlog')">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" stroke="currentColor" stroke-width="1.75" stroke-linecap="round"/></svg>
    Backlog
    <span class="nav-badge" id="backlogBadge" style="display:none"></span>
  </button>
  <button class="nav-tab" id="navCompleted" onclick="switchView('completed')">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 0 0 1.946-.806 3.42 3.42 0 0 1 4.438 0 3.42 3.42 0 0 0 1.946.806 3.42 3.42 0 0 1 3.138 3.138 3.42 3.42 0 0 0 .806 1.946 3.42 3.42 0 0 1 0 4.438 3.42 3.42 0 0 0-.806 1.946 3.42 3.42 0 0 1-3.138 3.138 3.42 3.42 0 0 0-1.946.806 3.42 3.42 0 0 1-4.438 0 3.42 3.42 0 0 0-1.946-.806 3.42 3.42 0 0 1-3.138-3.138 3.42 3.42 0 0 0-.806-1.946 3.42 3.42 0 0 1 0-4.438 3.42 3.42 0 0 0 .806-1.946 3.42 3.42 0 0 1 3.138-3.138z" stroke="currentColor" stroke-width="1.75"/></svg>
    Done
  </button>
</nav>

<!-- FAB -->
<button class="fab" id="fab" onclick="openSheet()" style="display:none">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.25" stroke-linecap="round"/></svg>
</button>

<!-- Add task sheet -->
<div class="sheet-overlay" id="sheetOverlay" onclick="handleOverlayClick(event)">
  <div class="sheet" id="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">New Task</div>

    <div class="dest-toggle">
      <button class="dest-btn active" id="destBacklog" onclick="setDest('backlog')">‚Üí Backlog</button>
      <button class="dest-btn" id="destToday" onclick="setDest('today')">‚Üí Today</button>
    </div>

    <textarea class="sheet-input" id="newTaskTitle" placeholder="What needs to get done?" rows="2" oninput="updateAddBtn()"></textarea>

    <div class="sheet-row">
      <input type="date" class="sheet-date" id="newTaskDue">
      <div class="hvm-toggle" id="hvmToggle" onclick="toggleHvm()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
        HVM
      </div>
    </div>

    <div class="sheet-actions">
      <button class="btn-cancel" onclick="closeSheet()">Cancel</button>
      <button class="btn-add" id="btnAdd" onclick="addTask()" disabled>Add Task</button>
    </div>
  </div>
</div>

<script>
  // ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
  const MAX_TODAY = 5;

  // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
  let data = { todayTasks: [], bankTasks: [], completedTasks: [], dailyCompletions: {}, lastOpenDate: getToday() };
  let view = 'today';
  let addDest = 'backlog';
  let newHvm = false;
  let unsubscribe = null;

  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
  function getToday() { return new Date().toISOString().split('T')[0]; }
  function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
  function daysBetween(a, b) {
    return Math.round((new Date(b) - new Date(a)) / 86400000);
  }
  function daysUntilDue(d) { return d ? daysBetween(getToday(), d) : Infinity; }
  function taskAge(addedDate) { return addedDate ? daysBetween(addedDate, getToday()) : 0; }

  function fmtDateFull(iso) {
    const d = new Date(iso + 'T12:00:00');
    return d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
  }

  function sortToday(tasks) {
    return [...tasks].sort((a,b) => {
      const da = a.dueDate ? daysUntilDue(a.dueDate) : Infinity;
      const db = b.dueDate ? daysUntilDue(b.dueDate) : Infinity;
      return da - db;
    });
  }

  function completedToday() {
    var today = getToday();
    return (data.dailyCompletions && data.dailyCompletions[today]) || 0;
  }

  function canAddToday() { return data.todayTasks.length < MAX_TODAY; }

  // ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
  async function save() {
    if (window.__f5_saveData) await window.__f5_saveData(data);
  }

  // ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ
  function addTask() {
    const title = document.getElementById('newTaskTitle').value.trim();
    if (!title) return;
    const due = document.getElementById('newTaskDue').value || null;
    const task = {
      id: genId(), title,
      dueDate: due, notes: '',
      hvm: newHvm,
      createdDate: new Date().toISOString(),
      addedToTodayDate: addDest === 'today' ? getToday() : null,
    };
    if (addDest === 'today' && canAddToday()) {
      data.todayTasks = sortToday([...data.todayTasks, task]);
    } else {
      data.bankTasks.push(task);
    }
    save();
    closeSheet();
  }

  function completeTask(id) {
    const idx = data.todayTasks.findIndex(t => t.id === id);
    if (idx === -1) return;
    const task = data.todayTasks[idx];
    const el = document.querySelector(`[data-task-id="${id}"]`);
    if (el) el.classList.add('completing');
    const today = getToday();
    if (!data.dailyCompletions) data.dailyCompletions = {};
    data.dailyCompletions[today] = (data.dailyCompletions[today] || 0) + 1;
    const completed = { ...task, completedDate: new Date().toISOString() };
    data.completedTasks = [completed, ...data.completedTasks];
    data.todayTasks = data.todayTasks.filter(t => t.id !== id);
    save();
  }

  function moveToToday(id) {
    if (!canAddToday()) return;
    const idx = data.bankTasks.findIndex(t => t.id === id);
    if (idx === -1) return;
    const task = data.bankTasks[idx];
    data.bankTasks = data.bankTasks.filter(t => t.id !== id);
    data.todayTasks = sortToday([...data.todayTasks, { ...task, addedToTodayDate: getToday() }]);
    save();
    if (view === 'backlog') switchView('today');
  }

  function moveToBacklog(id) {
    const idx = data.todayTasks.findIndex(t => t.id === id);
    if (idx === -1) return;
    const task = data.todayTasks[idx];
    data.todayTasks = data.todayTasks.filter(t => t.id !== id);
    const restored = { ...task };
    delete restored.addedToTodayDate;
    data.bankTasks.push(restored);
    save();
  }

  function uncompleteTask(id) {
    const task = data.completedTasks.find(t => t.id === id);
    if (!task) return;
    data.completedTasks = data.completedTasks.filter(t => t.id !== id);
    const restored = { ...task };
    delete restored.completedDate;
    const completedDay = task.completedDate ? task.completedDate.split('T')[0] : null;
    if (completedDay && data.dailyCompletions && data.dailyCompletions[completedDay] > 0) {
      data.dailyCompletions[completedDay]--;
    }
    data.bankTasks.push(restored);
    save();
  }

  // ‚îÄ‚îÄ SVG HELPERS ‚îÄ‚îÄ
  function checkSvgEl() {
    const s = document.createElementNS('http://www.w3.org/2000/svg','svg');
    s.setAttribute('width','10'); s.setAttribute('height','10');
    s.setAttribute('viewBox','0 0 12 12'); s.setAttribute('fill','none');
    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d','M2 6L5 9L10 3');
    p.setAttribute('stroke','white'); p.setAttribute('stroke-width','2');
    p.setAttribute('stroke-linecap','round'); p.setAttribute('stroke-linejoin','round');
    s.appendChild(p); return s;
  }

  function goldCheckSvgEl() {
    const s = document.createElementNS('http://www.w3.org/2000/svg','svg');
    s.setAttribute('width','10'); s.setAttribute('height','10');
    s.setAttribute('viewBox','0 0 12 12'); s.setAttribute('fill','none');
    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d','M2 6L5 9L10 3');
    p.setAttribute('stroke','#7A5F00'); p.setAttribute('stroke-width','2');
    p.setAttribute('stroke-linecap','round'); p.setAttribute('stroke-linejoin','round');
    s.appendChild(p); return s;
  }

  function starSvgEl(color) {
    const s = document.createElementNS('http://www.w3.org/2000/svg','svg');
    s.setAttribute('width','11'); s.setAttribute('height','11');
    s.setAttribute('viewBox','0 0 24 24'); s.setAttribute('fill', color || 'currentColor');
    s.className = 'hvm-star';
    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d','M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z');
    s.appendChild(p); return s;
  }

  function notesIconEl(task) {
    if (!(task.notes && task.notes.trim()) && !(task.checklist && task.checklist.length)) return null;
    const s = document.createElementNS('http://www.w3.org/2000/svg','svg');
    s.setAttribute('width','11'); s.setAttribute('height','11');
    s.setAttribute('viewBox','0 0 14 14'); s.setAttribute('fill','none');
    s.className = 'notes-icon';
    [[2,3,12,3],[2,6,10,6],[2,9,8,9]].forEach(l => {
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',l[0]); line.setAttribute('y1',l[1]);
      line.setAttribute('x2',l[2]); line.setAttribute('y2',l[3]);
      line.setAttribute('stroke','currentColor'); line.setAttribute('stroke-width','1.5');
      line.setAttribute('stroke-linecap','round');
      s.appendChild(line);
    });
    return s;
  }

  function dueBadgeEl(dueDate) {
    if (!dueDate) return null;
    const days = daysUntilDue(dueDate);
    const cls = days < 0 ? 'due-overdue' : days <= 2 ? 'due-urgent' : days <= 7 ? 'due-soon' : 'due-normal';
    const text = days < 0 ? Math.abs(days)+'d overdue' : days === 0 ? 'Today' : days === 1 ? 'Tomorrow' : days+'d left';
    const el = document.createElement('span');
    el.className = `due-badge ${cls}`;
    el.textContent = text;
    return el;
  }

  function ageBadgeEl(addedDate) {
    const age = taskAge(addedDate);
    if (age === 0) return null;
    const el = document.createElement('span');
    el.className = 'age-badge';
    el.textContent = age + 'd old';
    return el;
  }

  // ‚îÄ‚îÄ SHEET ‚îÄ‚îÄ
  function openSheet() {
    document.getElementById('sheetOverlay').classList.add('open');
    setTimeout(() => document.getElementById('newTaskTitle').focus(), 100);
    // Default dest based on view
    setDest(view === 'today' ? 'today' : 'backlog');
  }

  function closeSheet() {
    document.getElementById('sheetOverlay').classList.remove('open');
    document.getElementById('newTaskTitle').value = '';
    document.getElementById('newTaskDue').value = '';
    newHvm = false;
    document.getElementById('hvmToggle').classList.remove('active');
    updateAddBtn();
  }

  function handleOverlayClick(e) {
    if (e.target === document.getElementById('sheetOverlay')) closeSheet();
  }

  function setDest(dest) {
    addDest = dest;
    document.getElementById('destBacklog').classList.toggle('active', dest === 'backlog');
    document.getElementById('destToday').classList.toggle('active', dest === 'today');
    if (dest === 'today' && !canAddToday()) {
      document.getElementById('destToday').classList.remove('active');
      document.getElementById('destBacklog').classList.add('active');
      addDest = 'backlog';
    }
  }

  function toggleHvm() {
    newHvm = !newHvm;
    document.getElementById('hvmToggle').classList.toggle('active', newHvm);
  }

  function updateAddBtn() {
    const val = document.getElementById('newTaskTitle').value.trim();
    document.getElementById('btnAdd').disabled = !val;
  }

  // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
  function switchView(v) {
    view = v;
    ['today','backlog','completed'].forEach(name => {
      document.getElementById('view' + name.charAt(0).toUpperCase() + name.slice(1)).style.display = name === v ? '' : 'none';
      document.getElementById('nav' + name.charAt(0).toUpperCase() + name.slice(1)).classList.toggle('active', name === v);
    });
    // Hide FAB on completed
    document.getElementById('fab').style.display = v === 'completed' ? 'none' : '';
    render();
  }

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
  function render() {
    renderHeader();
    if (view === 'today') renderToday();
    if (view === 'backlog') renderBacklog();
    if (view === 'completed') renderCompleted();
    renderBadge();
  }

  function renderHeader() {
    const now = new Date();
    document.getElementById('headerDate').textContent = now.toLocaleDateString('en-US', { weekday:'long', month:'short', day:'numeric' });
    renderTracker();
  }

  function renderTracker() {
    const tracker = document.getElementById('headerTracker');
    tracker.innerHTML = '';
    const doneToday = completedToday();
    const today = getToday();
    const todayCompleted = (data.completedTasks || [])
      .filter(t => t.completedDate && t.completedDate.split('T')[0] === today)
      .sort((a,b) => new Date(a.completedDate) - new Date(b.completedDate));

    for (let i = 0; i < 5; i++) {
      const isFilled = i < doneToday;
      const isHvm = isFilled && todayCompleted[i] && todayCompleted[i].hvm;
      const dot = document.createElement('div');
      dot.className = 'tracker-dot';
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('width','22'); svg.setAttribute('height','22');
      svg.setAttribute('viewBox','0 0 26 26'); svg.setAttribute('fill','none');
      const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx','13'); circle.setAttribute('cy','13'); circle.setAttribute('r','11');
      circle.setAttribute('stroke', isFilled ? (isHvm ? '#F5C542' : 'white') : '#3a3a42');
      circle.setAttribute('stroke-width','1.5');
      circle.setAttribute('fill', isFilled ? (isHvm ? '#F5C542' : '#4A8C4A') : 'none');
      svg.appendChild(circle);
      if (isFilled) {
        const check = document.createElementNS('http://www.w3.org/2000/svg','path');
        check.setAttribute('d','M8 13L11.5 16.5L18 9');
        check.setAttribute('stroke', isHvm ? '#7A5F00' : 'white');
        check.setAttribute('stroke-width','1.5');
        check.setAttribute('stroke-linecap','round'); check.setAttribute('stroke-linejoin','round');
        svg.appendChild(check);
      }
      dot.appendChild(svg);
      tracker.appendChild(dot);
    }
    if (doneToday > 5) {
      const bonus = document.createElement('div');
      bonus.style.cssText = 'width:22px;height:22px;border-radius:50%;background:#F5C542;color:#7A5F00;font-family:DM Mono,monospace;font-size:0.6rem;font-weight:600;display:flex;align-items:center;justify-content:center;flex-shrink:0;';
      bonus.textContent = '+' + (doneToday - 5);
      tracker.appendChild(bonus);
    }
  }

  function renderBadge() {
    const badge = document.getElementById('backlogBadge');
    const count = data.bankTasks.length;
    badge.textContent = count;
    badge.style.display = count > 0 ? '' : 'none';
  }

  function renderToday() {
    const el = document.getElementById('viewToday');
    el.innerHTML = '';

    const doneToday = completedToday();
    const slotInfo = document.createElement('div');
    slotInfo.className = 'slot-info';
    slotInfo.textContent = `${data.todayTasks.length} / ${MAX_TODAY} slots  ¬∑  ${doneToday} completed today`;
    el.appendChild(slotInfo);

    if (data.todayTasks.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'empty-state';
      empty.innerHTML = '<div class="empty-icon">‚úì</div><div class="empty-text">No tasks for today.<br>Add up to 5 to focus on.</div>';
      el.appendChild(empty);
      return;
    }

    sortToday(data.todayTasks).forEach(task => {
      const item = document.createElement('div');
      item.className = 'task-item' + (task.hvm ? ' hvm' : '');
      item.setAttribute('data-task-id', task.id);

      const cb = document.createElement('div');
      cb.className = 'checkbox';
      cb.onclick = () => completeTask(task.id);

      const body = document.createElement('div');
      body.className = 'task-body';

      const titleRow = document.createElement('div');
      titleRow.style.cssText = 'display:flex;align-items:center;gap:6px;';
      if (task.hvm) titleRow.appendChild(starSvgEl('#F5C542'));
      const titleEl = document.createElement('span');
      titleEl.className = 'task-title';
      titleEl.textContent = task.title;
      titleRow.appendChild(titleEl);
      body.appendChild(titleRow);

      const meta = document.createElement('div');
      meta.className = 'task-meta';
      const ni = notesIconEl(task);
      if (ni) meta.appendChild(ni);
      const ab = ageBadgeEl(task.addedToTodayDate);
      if (ab) meta.appendChild(ab);
      const db = dueBadgeEl(task.dueDate);
      if (db) meta.appendChild(db);
      if (meta.children.length) body.appendChild(meta);

      const actBtn = document.createElement('button');
      actBtn.className = 'task-action';
      actBtn.title = 'Move to backlog';
      actBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 9l-7 7-7-7" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      actBtn.onclick = (e) => { e.stopPropagation(); moveToBacklog(task.id); };

      item.appendChild(cb);
      item.appendChild(body);
      item.appendChild(actBtn);
      el.appendChild(item);
    });
  }

  function renderBacklog() {
    const el = document.getElementById('viewBacklog');
    el.innerHTML = '';

    if (data.bankTasks.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'empty-state';
      empty.innerHTML = '<div class="empty-icon">üìã</div><div class="empty-text">Backlog is empty.<br>Add tasks for later.</div>';
      el.appendChild(empty);
      return;
    }

    data.bankTasks.forEach(task => {
      const item = document.createElement('div');
      item.className = 'task-item' + (task.hvm ? ' hvm' : '');

      const body = document.createElement('div');
      body.className = 'task-body';

      const titleRow = document.createElement('div');
      titleRow.style.cssText = 'display:flex;align-items:center;gap:6px;';
      if (task.hvm) titleRow.appendChild(starSvgEl('#F5C542'));
      const titleEl = document.createElement('span');
      titleEl.className = 'task-title';
      titleEl.textContent = task.title;
      titleRow.appendChild(titleEl);
      body.appendChild(titleRow);

      const meta = document.createElement('div');
      meta.className = 'task-meta';
      const ni = notesIconEl(task);
      if (ni) meta.appendChild(ni);
      const db = dueBadgeEl(task.dueDate);
      if (db) meta.appendChild(db);
      if (meta.children.length) body.appendChild(meta);

      const addBtn = document.createElement('button');
      addBtn.className = 'task-action';
      addBtn.title = canAddToday() ? 'Move to Today' : 'Today is full';
      addBtn.disabled = !canAddToday();
      addBtn.style.opacity = canAddToday() ? '1' : '0.35';
      addBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 15l7-7 7 7" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      addBtn.onclick = (e) => { e.stopPropagation(); moveToToday(task.id); };

      item.appendChild(body);
      item.appendChild(addBtn);
      el.appendChild(item);
    });
  }

  function renderCompleted() {
    const el = document.getElementById('viewCompleted');
    el.innerHTML = '';

    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - 7);
    cutoff.setHours(0,0,0,0);
    const recent = data.completedTasks.filter(t => new Date(t.completedDate) >= cutoff);

    if (recent.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'empty-state';
      empty.innerHTML = '<div class="empty-icon">‚úì</div><div class="empty-text">No completed tasks in the last 7 days.</div>';
      el.appendChild(empty);
      return;
    }

    const byDay = {};
    recent.forEach(t => {
      const day = t.completedDate.split('T')[0];
      if (!byDay[day]) byDay[day] = [];
      byDay[day].push(t);
    });

    Object.keys(byDay).sort((a,b) => b.localeCompare(a)).forEach(day => {
      const label = document.createElement('div');
      label.className = 'comp-day-label';
      label.innerHTML = `<span>${day === getToday() ? 'Today' : fmtDateFull(day)}</span><span>${byDay[day].length} task${byDay[day].length !== 1 ? 's' : ''}</span>`;
      el.appendChild(label);

      byDay[day].forEach(task => {
        const item = document.createElement('div');
        item.className = 'comp-item';

        const chk = document.createElement('div');
        chk.className = 'comp-check' + (task.hvm ? ' hvm' : '');
        chk.appendChild(task.hvm ? goldCheckSvgEl() : checkSvgEl());

        const title = document.createElement('span');
        title.className = 'comp-title';
        title.textContent = task.title;

        const undo = document.createElement('button');
        undo.className = 'undo-btn';
        undo.title = 'Undo';
        undo.innerHTML = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none"><path d="M3 10h10a5 5 0 0 1 0 10H7M3 10l4-4M3 10l4 4" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        undo.onclick = () => uncompleteTask(task.id);

        item.appendChild(chk);
        item.appendChild(title);
        item.appendChild(undo);
        el.appendChild(item);
      });
    });
  }

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
  function showApp() {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('appHeader').style.display = '';
    document.getElementById('scrollBody').style.display = '';
    document.getElementById('bottomNav').style.display = '';
    document.getElementById('fab').style.display = '';
    switchView('today');
  }

  function showError(emoji, title, body, detail) {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('errorEmoji').textContent = emoji || '‚öôÔ∏è';
    document.getElementById('errorTitle').textContent = title;
    document.getElementById('errorBody').textContent = body;
    if (detail) document.getElementById('errorDetail').textContent = detail;
    document.getElementById('configError').classList.add('show');
  }

  // Expose so Firebase module can call it on save errors
  window.__f5_setError = (msg) => showError('‚ö†Ô∏è', 'Sync error', 'A Firestore error occurred.', msg);

  function isPlaceholderConfig() {
    const script = document.querySelector('script[type="module"]').textContent;
    return script.includes('"YOUR_API_KEY"');
  }

  document.addEventListener('f5-firebase-ready', () => {
    // Config not filled in
    if (isPlaceholderConfig()) {
      showError('‚öôÔ∏è', 'Firebase not configured',
        'Open focus5-mobile.html in a text editor and paste your Firebase config where it says YOUR_API_KEY. See SETUP-GUIDE.md for step-by-step instructions.');
      return;
    }

    // Firebase threw an error during init (bad config values, etc.)
    if (window.__f5_initError) {
      showError('üîë', 'Firebase config error',
        'Firebase could not start. Double-check that you pasted the full config correctly ‚Äî all 6 fields.',
        window.__f5_initError);
      return;
    }

    // Start real-time listener
    let appShown = false;
    unsubscribe = window.__f5_onData(
      payload => {
        if (payload !== '__EMPTY__') {
          // Document exists ‚Äî parse it
          try {
            const incoming = JSON.parse(payload);
            data = incoming;
            if (!data.dailyCompletions) data.dailyCompletions = {};
          } catch(e) {
            // Corrupted data ‚Äî start fresh
          }
        }
        // Whether doc exists or not, we got a response ‚Äî show the app
        if (!appShown) { appShown = true; showApp(); }
        render();
      },
      err => {
        // Firestore listener error ‚Äî most common causes shown to user
        let title = 'Firestore connection failed';
        let body = 'Could not connect to your database.';
        let detail = err.message || String(err);

        if (detail.includes('permission') || detail.includes('PERMISSION_DENIED')) {
          title = 'Firestore rules blocked access';
          body = 'Go to Firebase Console ‚Üí Firestore ‚Üí Rules tab and make sure you published the rules from SETUP-GUIDE.md Step 3.';
        } else if (detail.includes('project') || detail.includes('NOT_FOUND')) {
          title = 'Project not found';
          body = 'The projectId in your config does not match any Firebase project. Double-check it in the Firebase Console ‚Üí Project Settings.';
        } else if (detail.includes('network') || detail.includes('offline') || detail.includes('unavailable')) {
          title = 'No internet connection';
          body = 'Could not reach Firebase. Check that your phone has internet access and try again.';
        } else if (detail.includes('quota')) {
          title = 'Firestore quota exceeded';
          body = 'Your Firebase free tier limit was hit. This should not happen for personal use ‚Äî check your Firebase Console for unusual activity.';
        }

        if (!appShown) showError('üî•', title, body, detail);
      }
    );

    // Safety net: if onSnapshot never fires at all (e.g. network timeout), show error after 12s
    setTimeout(() => {
      if (!appShown) {
        showError('üì°', 'Connection timed out',
          'Firebase connected but Firestore never responded. This usually means: (1) Firestore was not created in your project ‚Äî go to Firebase Console ‚Üí Firestore Database and create it, or (2) your security rules were not published.',
          'Timed out after 12 seconds waiting for first snapshot.');
      }
    }, 12000);
  });

  // Hard fallback: Firebase module itself failed to load (no internet, blocked, etc.)
  setTimeout(() => {
    if (!window.__f5_ready) {
      showError('üì°', 'Could not load Firebase',
        'The Firebase SDK failed to load. Make sure your phone has internet access. If you are on a restricted network, the gstatic.com domain may be blocked.');
    }
  }, 10000);

  // Close sheet on back gesture / escape
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeSheet(); });
</script>
</body>
</html>
